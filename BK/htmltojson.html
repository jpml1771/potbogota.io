<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador JSON desde HTML - POT Bogot√°</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center justify-center p-6 font-sans">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl">
        <h1 class="text-2xl font-bold text-slate-800 mb-2">Convertidor HTML a JSON (√Årbol Profundo)</h1>
        <p class="text-slate-600 mb-6 text-sm">Escanea tu documento exportado como <b>P√°gina Web (.html)</b> desde Word. Incorpora un motor de anidamiento exacto para jerarqu√≠as infinitas y rescate de im√°genes.</p>
        
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <p class="text-sm text-blue-800 font-medium">üí° Tip para Word:</p>
            <p class="text-xs text-blue-700 mt-1">Si tus subsecciones (ej. 1.1.1) no aparecen, aseg√∫rate de que en Word no est√©n usando "Numeraci√≥n Autom√°tica". Escr√≠belas como texto normal antes de exportar a HTML.</p>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-medium text-slate-700 mb-2">1. Sube tu documento exportado (.html)</label>
            <input type="file" id="upload" accept=".html,.htm" class="block w-full text-sm text-slate-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-md file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-600 file:text-white
              hover:file:bg-blue-700 transition-all cursor-pointer border border-slate-200 rounded-lg p-2" />
        </div>

        <div id="status" class="hidden mb-6 p-4 rounded-lg bg-blue-50 text-blue-700 text-sm font-medium border border-blue-200">
            Procesando documento HTML, escaneando estructura de √°rbol...
        </div>

        <button id="downloadBtn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition-colors shadow-lg flex justify-center items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            Descargar BASE.json
        </button>

        <div id="log" class="mt-6 text-xs text-slate-500 bg-slate-50 p-4 rounded-lg h-48 overflow-y-auto font-mono border border-slate-200 hidden"></div>
    </div>

    <script>
        let generatedJson = null;
        const logArea = document.getElementById('log');

        function log(msg) {
            logArea.classList.remove('hidden');
            logArea.innerHTML += `<div>> ${msg}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        document.getElementById('upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('status').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.add('hidden');
            logArea.innerHTML = '';
            log("Archivo HTML cargado. Iniciando escaneo profundo del DOM...");

            const reader = new FileReader();
            reader.onload = function(loadEvent) {
                const htmlString = loadEvent.target.result;
                processHTML(htmlString);
            };
            reader.readAsText(file);
        });

        function processHTML(htmlString) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;

            const potJson = {
                document_info: {
                    title: "MANUAL DE NORMAS COMUNES A LOS TRATAMIENTOS URBAN√çSTICOS",
                    decree: "DECRETO DISTRITAL 555 DE 2021",
                    entity: "SECRETAR√çA DISTRITAL DE PLANEACI√ìN",
                    date: "Noviembre 2022"
                },
                chapters: []
            };

            // TRUE TREE BUILDER - Rutas de anidamiento infinito
            let numPath = { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null };
            let aparPath = { 1: null, 2: null, 3: null, 4: null, 5: null };
            let activeNode = null;

            let stats = { caps: 0, secs: 0, subs: 0, apartados: 0, imagenes: 0, saltados: 0 };

            let blocks = [];
            function traverse(node) {
                if (node.nodeType !== 1) return;
                const tag = node.tagName.toUpperCase();
                // Si encontramos un bloque v√°lido, lo extraemos. 
                if (['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'TABLE', 'UL', 'OL'].includes(tag)) {
                    blocks.push(node);
                } else {
                    Array.from(node.children).forEach(traverse);
                }
            }
            
            traverse(tempDiv);
            log(`Se encontraron ${blocks.length} bloques de contenido en total.`);

            blocks.forEach((child) => {
                if (child.className && typeof child.className === 'string' && child.className.includes('MsoToc')) {
                    stats.saltados++;
                    return;
                }

                const text = child.textContent.trim().replace(/\s+/g, ' '); 
                const hasImage = child.innerHTML.toLowerCase().includes('<img') || child.innerHTML.toLowerCase().includes('v:imagedata');
                
                if (!text && child.tagName !== 'TABLE' && !hasImage) return;

                if (hasImage) stats.imagenes++;

                const upperText = text.toUpperCase();
                if (upperText === 'CONTENIDO' || upperText === 'CONTENIDO:' || upperText === 'TABLA DE CONTENIDO') {
                    stats.saltados++;
                    return;
                }

                // Regex Ultra-Tolerantes (Ignoran vi√±etas ocultas o espacios extra√±os)
                const matchCap = text.match(/^(?:[\u2022\-\*\>]\s*)?(?:(?:CAP[√çI]TULO)\s+([0-9IVX]+)|([0-9IVX]+)\.)[\.\-]?\s+(.*)/i);
                const matchNum = text.match(/^(?:[\u2022\-\*\>]\s*)?(?:(?:CAP|ART[√çI]CULO)[^\d]*\d+\.?\s*)?((?:\d+\s*[\.\-]\s*)+\d+)\.?\s*(.*)/i);
                const matchApar = text.match(/^(?:[\u2022\-\*\>]\s*)?([A-Za-z]{1,2}(?:\s*[\.\-]\s*\d+)+[\.\)]?|[A-Za-z]{1,2}[\.\)])\s+(.*)/);

                if (matchCap) {
                    let capNum = matchCap[1] || matchCap[2];
                    let capTitle = matchCap[3];
                    
                    const safeNum = capNum.replace(/\./g, '\\.');
                    const regexDup = new RegExp(`^${safeNum}[\\.\\s\\-]+`, 'i');
                    capTitle = capTitle.replace(regexDup, '').trim();

                    let node = { id: `CAP_${capNum}`, number: capNum, title: capTitle, sections: [] };
                    potJson.chapters.push(node);
                    
                    numPath = { 1: node, 2: null, 3: null, 4: null, 5: null, 6: null };
                    aparPath = { 1: null, 2: null, 3: null, 4: null };
                    activeNode = node;
                    
                    stats.caps++;
                    log(`Estructurando: Cap√≠tulo ${capNum}`);
                }
                else if (matchNum) {
                    let rawNum = matchNum[1].replace(/\s*[\.\-]\s*/g, '.');
                    let title = matchNum[2].trim();
                    const depth = rawNum.split('.').length;

                    const safeNum = rawNum.replace(/\./g, '\\.');
                    const regexDup = new RegExp(`^${safeNum}[\\.\\s\\-]+`, 'i');
                    title = title.replace(regexDup, '');

                    let node = { number: rawNum, title: title, content: "", subsections: [], apartados: [] };

                    if (depth === 2) {
                        if (!numPath[1]) {
                            let cap = { id: `CAP_0`, number: "0", title: "General", sections: [] };
                            potJson.chapters.push(cap);
                            numPath[1] = cap;
                        }
                        numPath[1].sections.push(node);
                        stats.secs++;
                    } 
                    else if (depth >= 3) {
                        // Buscar el padre m√°s cercano en el √°rbol
                        let pDepth = depth - 1;
                        while(pDepth >= 2 && !numPath[pDepth]) pDepth--;
                        
                        if (numPath[pDepth]) {
                            numPath[pDepth].subsections.push(node);
                        } else if (numPath[1]) {
                            // Si falta la secci√≥n madre, crear un puente gen√©rico
                            let dummy = { number: "0.0", title: "General", content: "", subsections: [], apartados: [] };
                            numPath[1].sections.push(dummy);
                            numPath[2] = dummy;
                            numPath[2].subsections.push(node);
                        }
                        stats.subs++;
                        log(`Detectada Subsecci√≥n Nivel ${depth}: ${rawNum}`);
                    }
                    
                    // Actualizar el camino activo y borrar inferiores
                    numPath[depth] = node;
                    for (let i = depth + 1; i <= 8; i++) numPath[i] = null;
                    aparPath = { 1: null, 2: null, 3: null, 4: null };
                    activeNode = node;
                }
                else if (matchApar) {
                    let rawAparNum = matchApar[1].replace(/[\.\)]$/, '').trim(); 
                    let num = rawAparNum.replace(/\s*[\.\-]\s*/g, '.');
                    let title = matchApar[2].trim();
                    const aDepth = num.split('.').length;
                    
                    let node = { id: num, title: title, content: "", apartados: [] };

                    if (aDepth === 1) {
                        // Enganchar al nodo num√©rico m√°s profundo disponible
                        let numParent = null;
                        for (let i = 8; i >= 2; i--) {
                            if (numPath[i]) { numParent = numPath[i]; break; }
                        }
                        if (numParent) numParent.apartados.push(node);
                    } else {
                        // Enganchar al apartado padre
                        let pDepth = aDepth - 1;
                        while(pDepth >= 1 && !aparPath[pDepth]) pDepth--;
                        if (aparPath[pDepth]) {
                            aparPath[pDepth].apartados.push(node);
                        } else {
                            // Si falla, colgarlo del num√©rico
                            let numParent = null;
                            for (let i = 8; i >= 2; i--) {
                                if (numPath[i]) { numParent = numPath[i]; break; }
                            }
                            if (numParent) numParent.apartados.push(node);
                        }
                    }
                    
                    aparPath[aDepth] = node;
                    for (let i = aDepth + 1; i <= 5; i++) aparPath[i] = null;
                    activeNode = node;
                    
                    stats.apartados++;
                    log(`Detectado Apartado: ${num}`);
                }
                else {
                    // Limpieza de tablas
                    if (child.tagName === 'TABLE') {
                        child.className = "min-w-full text-sm text-left text-slate-500 border-collapse border border-slate-200 my-4";
                        child.querySelectorAll('th, td, tr, thead, tbody').forEach(cell => {
                            cell.removeAttribute('style');
                            cell.removeAttribute('class');
                            if (cell.tagName === 'TH' || cell.tagName === 'TD') {
                                cell.className = "border border-slate-200 px-4 py-2";
                            }
                        });
                    } else {
                        child.removeAttribute('style');
                        child.removeAttribute('class');
                    }

                    const htmlContent = child.outerHTML;

                    // Adjuntar al nodo activo de forma segura
                    if (activeNode && activeNode.content !== undefined) {
                        activeNode.content += htmlContent;
                    }
                }
            });

            log(`An√°lisis completado: ${stats.caps} Caps, ${stats.secs} Secs, ${stats.subs} Subniveles anidados, ${stats.apartados} Apartados.`);
            log(`Im√°genes rescatadas: ${stats.imagenes}`);
            
            generatedJson = potJson;
            
            document.getElementById('status').innerText = "¬°√Årbol estructurado y JSON generado con √©xito!";
            document.getElementById('status').classList.replace('bg-blue-50', 'bg-green-50');
            document.getElementById('status').classList.replace('text-blue-700', 'text-green-700');
            document.getElementById('downloadBtn').classList.remove('hidden');
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!generatedJson) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(generatedJson, null, 2));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "BASE.json");
            dlAnchorElem.click();
            log("Archivo BASE.json descargado.");
        });
    </script>
</body>
</html>