<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador JSON desde HTML - POT Bogotá</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center justify-center p-6 font-sans">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl">
        <h1 class="text-2xl font-bold text-slate-800 mb-2">Convertidor HTML a JSON (Definitivo)</h1>
        <p class="text-slate-600 mb-6 text-sm">Esta herramienta escanea documentos exportados como <b>Página Web (.html)</b> desde Word. Rescata imágenes, tablas y procesa niveles infinitos (ej. 1.1.1.1 o A.1.1).</p>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-slate-700 mb-2">1. Sube tu documento exportado (.html)</label>
            <input type="file" id="upload" accept=".html,.htm" class="block w-full text-sm text-slate-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-50 file:text-blue-700
              hover:file:bg-blue-100 transition-all cursor-pointer border border-slate-200 rounded-lg p-2" />
        </div>

        <div id="status" class="hidden mb-6 p-4 rounded-lg bg-blue-50 text-blue-700 text-sm font-medium border border-blue-200">
            Procesando documento HTML, escaneando secciones y rescatando imágenes...
        </div>

        <button id="downloadBtn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition-colors shadow-lg flex justify-center items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            Descargar BASE.json
        </button>

        <div id="log" class="mt-6 text-xs text-slate-500 bg-slate-50 p-4 rounded-lg h-48 overflow-y-auto font-mono border border-slate-200 hidden"></div>
    </div>

    <script>
        let generatedJson = null;
        const logArea = document.getElementById('log');

        function log(msg) {
            logArea.classList.remove('hidden');
            logArea.innerHTML += `<div>> ${msg}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        document.getElementById('upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('status').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.add('hidden');
            logArea.innerHTML = '';
            log("Archivo HTML cargado. Iniciando escaneo profundo del DOM...");

            const reader = new FileReader();
            reader.onload = function(loadEvent) {
                const htmlString = loadEvent.target.result;
                processHTML(htmlString);
            };
            reader.readAsText(file);
        });

        function processHTML(htmlString) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;

            const potJson = {
                document_info: {
                    title: "MANUAL DE NORMAS COMUNES A LOS TRATAMIENTOS URBANÍSTICOS",
                    decree: "DECRETO DISTRITAL 555 DE 2021",
                    entity: "SECRETARÍA DISTRITAL DE PLANEACIÓN",
                    date: "Noviembre 2022"
                },
                chapters: []
            };

            let curCap = null;
            let curSec = null;
            let curSub = null;
            let curApar = null;

            let stats = { caps: 0, secs: 0, subs: 0, apartados: 0, tablas: 0, imagenes: 0, saltados: 0 };

            // Recorre recursivamente buscando contenedores reales de contenido
            let blocks = [];
            function traverse(node) {
                if (node.nodeType !== 1) return;
                const tag = node.tagName.toUpperCase();
                if (['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'TABLE', 'UL', 'OL'].includes(tag)) {
                    blocks.push(node);
                } else {
                    Array.from(node.children).forEach(traverse);
                }
            }
            
            traverse(tempDiv);
            log(`Se encontraron ${blocks.length} bloques de contenido en total.`);

            blocks.forEach((child) => {
                // Filtramos la Tabla de Contenido de Word
                if (child.className && typeof child.className === 'string' && child.className.includes('MsoToc')) {
                    stats.saltados++;
                    return;
                }

                const text = child.textContent.trim().replace(/\s+/g, ' '); 
                
                // Detecta si hay una imagen, aún si Word la ocultó en código "v:imagedata"
                const hasImage = child.innerHTML.toLowerCase().includes('<img') || child.innerHTML.toLowerCase().includes('v:imagedata');
                
                // Ignorar si está vacío Y no tiene imagen Y no es una tabla
                if (!text && child.tagName !== 'TABLE' && !hasImage) return;

                if (hasImage) stats.imagenes++;

                const upperText = text.toUpperCase();
                if (upperText === 'CONTENIDO' || upperText === 'CONTENIDO:' || upperText === 'TABLA DE CONTENIDO') {
                    stats.saltados++;
                    return;
                }

                // Expresiones regulares ultra-tolerantes a espacios extra (ej. "A . 1", "1 - 1")
                const matchCap = text.match(/^(?:(?:[0-9IVX]+\.?\s*)?CAP[ÍI]TULO\s+([0-9IVX]+)|([0-9IVX]+)\.)[\.\-]?\s+(.*)/i);
                const matchNum = text.match(/^(?:(?:CAP|ART[ÍI]CULO)[^\d]*\d+\.?\s*)?((?:\d+\s*[\.\-]\s*)+\d+)\.?\s*(.*)/i);
                const matchApar = text.match(/^([A-Za-z]{1,2}(?:\s*[\.\-]\s*\d+)+[\.\)]?|[A-Za-z]{1,2}[\.\)])\s+(.*)/);

                let isCap = false;
                let capNum = null;
                let capTitle = "";

                if (matchCap) {
                    capNum = matchCap[1] || matchCap[2];
                    capTitle = matchCap[3];
                    if (!matchCap[1]) {
                        const isAllUppercase = (capTitle.toUpperCase() === capTitle);
                        if (isAllUppercase) isCap = true;
                    } else {
                        isCap = true;
                    }
                }

                if (isCap) {
                    const safeNum = capNum.replace(/\./g, '\\.');
                    const regexDup = new RegExp(`^${safeNum}[\\.\\s\\-]+`, 'i');
                    capTitle = capTitle.replace(regexDup, '').trim();

                    curCap = { id: `CAP_${capNum}`, number: capNum, title: capTitle, sections: [] };
                    potJson.chapters.push(curCap);
                    curSec = null; curSub = null; curApar = null;
                    stats.caps++;
                    log(`Detectado: Capítulo ${capNum}`);
                }
                else if (matchNum) {
                    // Normaliza espacios en los números
                    let rawNum = matchNum[1].replace(/\s*[\.\-]\s*/g, '.');
                    let title = matchNum[2].trim();
                    const depth = rawNum.split('.').length;

                    const safeNum = rawNum.replace(/\./g, '\\.');
                    const regexDup = new RegExp(`^${safeNum}[\\.\\s\\-]+`, 'i');
                    title = title.replace(regexDup, '');

                    if (depth === 2) {
                        if (!curCap) {
                            curCap = { id: `CAP_0`, number: "0", title: "General", sections: [] };
                            potJson.chapters.push(curCap);
                        }
                        curSec = { number: rawNum, title: title, content: "", subsections: [], apartados: [] };
                        curCap.sections.push(curSec);
                        curSub = null; curApar = null;
                        stats.secs++;
                    } 
                    else if (depth >= 3) {
                        if (!curCap) {
                            curCap = { id: `CAP_0`, number: "0", title: "General", sections: [] };
                            potJson.chapters.push(curCap);
                        }
                        if (!curSec) {
                            curSec = { number: "0.0", title: "General", content: "", subsections: [], apartados: [] };
                            curCap.sections.push(curSec);
                        }
                        curSub = { number: rawNum, title: title, content: "", apartados: [] };
                        curSec.subsections.push(curSub); // El Visor se encarga de indentar esto según su profundidad
                        curApar = null;
                        stats.subs++;
                        log(`Detectada Subsección: ${rawNum}`);
                    }
                }
                else if (matchApar) {
                    let rawAparNum = matchApar[1].replace(/[\.\)]$/, '').trim(); 
                    let num = rawAparNum.replace(/\s*[\.\-]\s*/g, '.');
                    let title = matchApar[2].trim();
                    
                    curApar = { id: num, title: title, content: "" };
                    
                    if (curSub) curSub.apartados.push(curApar);
                    else if (curSec) curSec.apartados.push(curApar);
                    stats.apartados++;
                    log(`Detectado Apartado: ${num}`);
                }
                else {
                    child.removeAttribute('style');
                    child.removeAttribute('class');
                    
                    if (child.tagName === 'TABLE') {
                        child.className = "min-w-full text-sm text-left text-slate-500 border-collapse border border-slate-200 my-4";
                        child.querySelectorAll('th, td, tr, thead, tbody').forEach(cell => {
                            cell.removeAttribute('style');
                            cell.removeAttribute('class');
                            if (cell.tagName === 'TH' || cell.tagName === 'TD') {
                                cell.className = "border border-slate-200 px-4 py-2";
                            }
                        });
                        stats.tablas++;
                    }

                    const htmlContent = child.outerHTML;

                    if (curApar) {
                        curApar.content += htmlContent;
                    } else if (curSub) {
                        curSub.content += htmlContent;
                    } else if (curSec) {
                        curSec.content += htmlContent;
                    }
                }
            });

            log(`Análisis completado: ${stats.caps} Caps, ${stats.secs} Secs, ${stats.subs} Subniveles, ${stats.apartados} Apartados.`);
            log(`Se rescataron y preservaron ${stats.imagenes} bloques con imágenes.`);
            
            generatedJson = potJson;
            
            document.getElementById('status').innerText = "¡Éxito! JSON generado y listo para usarse en el Visor.";
            document.getElementById('status').classList.replace('bg-blue-50', 'bg-green-50');
            document.getElementById('status').classList.replace('text-blue-700', 'text-green-700');
            document.getElementById('downloadBtn').classList.remove('hidden');
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!generatedJson) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(generatedJson, null, 2));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "BASE.json");
            dlAnchorElem.click();
            log("Archivo BASE.json descargado limpiamente.");
        });
    </script>
</body>
</html>