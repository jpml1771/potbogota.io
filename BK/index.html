<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Normas Urbanísticas - Bogotá (Directo)</title>
    
    <!-- Importar la fuente 'Inter' desde Google Fonts para un look premium estilo UpCodes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { 
            overflow: hidden; 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            scroll-behavior: smooth; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Scrollbars elegantes */
        #sidebar::-webkit-scrollbar, #content-pane::-webkit-scrollbar { width: 6px; }
        #sidebar::-webkit-scrollbar-thumb, #content-pane::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        /* PREVENCIÓN DE SUBRAYADOS Y ESTILOS POR DEFECTO EN EL MENÚ */
        #sidebar a, .nav-link { 
            text-decoration: none !important; 
            outline: none !important;
            box-shadow: none !important;
        }

        /* ESTILO ACTIVO DEL MENÚ (Highlight de sección actual - Neutro y limpio) */
        .nav-link.active { 
            background-color: #f8fafc !important; /* Fondo gris ultra suave (slate-50) */
            color: #0f172a !important; /* Texto oscuro/negro (slate-900) */
            font-weight: 700 !important; 
            border-left-color: #475569 !important; /* Borde indicador gris oscuro (slate-600) */
            border-left-width: 3px !important;
        }
        
        /* ESTILOS DE CONTENIDO PRINCIPAL */
        /* Forzar 'Inter' en TODO el contenido, ignorando CSS de Word */
        #main-content, #main-content * { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif !important;
        }

        #main-content { 
            color: #334155; 
            font-size: 1.05rem; 
        }
        
        /* Párrafos: Alineados a la izquierda y con espaciado forzado limpio */
        #main-content p { 
            margin-bottom: 1.25rem !important; 
            line-height: 1.8 !important; 
            text-align: left !important; 
            max-width: 100%; 
            word-wrap: break-word; 
        }
        
        /* Asegurar que las letras internas (spans) hereden el interlineado del párrafo */
        #main-content span {
            line-height: inherit !important;
        }

        #main-content p:empty { display: none; }
        
        /* Títulos inyectados sobre el HTML de Word */
        .visor-chapter-title { 
            display: flex !important; align-items: flex-start !important; gap: 1rem !important;
            font-size: 1.5rem !important; font-weight: 800 !important; color: #0f172a !important; 
            margin-top: 4rem !important; margin-bottom: 2.5rem !important; 
            border-bottom: 2px solid #e2e8f0 !important; padding-bottom: 1rem !important; 
            line-height: 1.3 !important; clear: both;
            text-indent: 0 !important; margin-left: 0 !important; 
        }
        
        .visor-section-title { 
            display: flex !important; align-items: flex-start !important; gap: 0.85rem !important;
            margin-top: 3rem !important; margin-bottom: 1.25rem !important; 
            line-height: 1.4 !important; 
            text-indent: 0 !important; margin-left: 0 !important; 
        }
        
        /* Ajustes de jerarquía y color */
        .visor-depth-2 { font-size: 1.25rem !important; font-weight: 700 !important; color: #0f172a !important; border-bottom: 1px solid #f1f5f9 !important; padding-bottom: 0.75rem !important; }
        .visor-depth-3 { font-size: 1.15rem !important; font-weight: 700 !important; color: #1e293b !important; }
        .visor-depth-4 { font-size: 1.05rem !important; font-weight: 600 !important; color: #334155 !important; }
        .visor-depth-5 { font-size: 1rem !important; font-weight: 600 !important; color: #1e40af !important; padding-left: 0.5rem !important; }
        .visor-depth-6 { font-size: 0.95rem !important; font-weight: 600 !important; color: #2563eb !important; padding-left: 1.5rem !important; }

        /* Tablas, Listas e Imágenes limpias */
        #main-content table { width: 100% !important; border-collapse: collapse; margin: 2.5rem 0; font-size: 0.9rem; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        #main-content td, #main-content th { border: 1px solid #e2e8f0 !important; padding: 1rem !important; text-align: left; vertical-align: top; line-height: 1.5; }
        #main-content th { background-color: #f8fafc !important; font-weight: 700 !important; color: #0f172a !important; }
        #main-content img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 2rem auto; display: block; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; }
        
        #main-content ul { list-style-type: disc; padding-left: 2.5rem; margin-bottom: 1.5rem; color: #334155; }
        #main-content ol { list-style-type: decimal; padding-left: 2.5rem; margin-bottom: 1.5rem; color: #334155; }
        #main-content li { margin-bottom: 0.75rem; line-height: 1.8 !important; text-align: left !important; }

        /* Ocultar elementos basura de Word */
        #main-content a[name^="_Toc"] { display: block; padding-top: 1rem; pointer-events: none; }
        #main-content .MsoToc { display: none !important; }
        #main-content span[style*="mso-hide:screen"], #main-content span[style*="display:none"] { display: none !important; }

        /* Animaciones del Sidebar */
        summary { list-style: none; cursor: pointer; outline: none; user-select: none; }
        summary::-webkit-details-marker { display: none; }
        .chapter-summary { display: flex; align-items: center; justify-content: space-between; }
        .chapter-summary .icon { transition: transform 0.2s ease; font-size: 0.8em; color: #94a3b8; }
        details[open] > .chapter-summary .icon { transform: rotate(90deg); }
        details[open] > .section-list { display: block; }
        .section-list { display: none; }
    </style>
</head>
<body class="h-full bg-white text-slate-800">

    <!-- PANTALLA DE CARGA AUTOMÁTICA -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-50 z-50 flex items-center justify-center p-6">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-200 border-t-blue-700 mb-4"></div>
            <h2 class="text-xl font-bold text-slate-800">Cargando Normativa...</h2>
            <p class="text-slate-500 text-sm mt-2">Preparando el documento interactivo</p>
        </div>
    </div>

    <!-- PANTALLA DE INICIO (Carga Manual como Plan B) -->
    <div id="upload-screen" class="fixed inset-0 bg-slate-50 z-50 flex items-center justify-center p-6 hidden">
        <div class="bg-white p-8 md:p-12 rounded-2xl shadow-xl w-full max-w-2xl text-center">
            <div class="bg-amber-100 text-amber-700 p-4 rounded-full inline-block mb-4 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2">Carga Local Requerida</h1>
            <p class="text-slate-500 mb-8 text-sm max-w-md mx-auto">Parece que estás abriendo el archivo localmente sin un servidor. Por favor, sube manualmente tu archivo <b>.html</b> exportado de Word para visualizarlo.</p>
            
            <div class="relative w-full">
                <input type="file" id="upload-html" accept=".html,.htm" class="block w-full text-sm text-slate-500
                    file:mr-4 file:py-3 file:px-6
                    file:rounded-full file:border-0
                    file:text-sm file:font-bold
                    file:bg-blue-600 file:text-white
                    file:shadow-md file:cursor-pointer
                    hover:file:bg-blue-700 transition-all border border-slate-200 rounded-full p-2 bg-slate-50 cursor-pointer" />
            </div>
        </div>
    </div>

    <!-- VISOR PRINCIPAL -->
    <div id="app-screen" class="flex h-full flex-col hidden">
        
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 py-3 px-6 shadow-sm z-40 flex-shrink-0">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <button id="menu-btn" class="md:hidden text-slate-600 p-1 hover:text-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div>
                        <h1 class="text-lg font-extrabold text-slate-800 leading-tight tracking-tight">POT Bogotá</h1>
                        <p class="text-[10px] text-blue-600 font-bold tracking-widest uppercase">Normas Urbanísticas</p>
                    </div>
                </div>
                <div class="w-full md:max-w-md ml-auto">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </span>
                        <input type="search" id="search" placeholder="Buscar sección en el menú..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none text-sm transition-all" />
                    </div>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative">
            <!-- Sidebar Mobile Overlay -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-20 hidden md:hidden"></div>

            <!-- Sidebar Nav Pane -->
            <nav id="sidebar" class="absolute md:relative z-30 inset-y-0 left-0 w-72 md:w-80 flex-shrink-0 overflow-y-auto bg-slate-50 border-r border-slate-200 transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-xl md:shadow-none">
                <div class="p-4 border-b border-slate-200 bg-slate-50/90 backdrop-blur sticky top-0 z-10 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Contenido</h3>
                    <button id="close-menu-btn" class="md:hidden text-slate-400 hover:text-slate-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="sidebar-content" class="p-3 space-y-1 pb-20"></div>
            </nav>

            <!-- Main Content Area - Totalmente expandido -->
            <main id="content-pane" class="flex-1 overflow-y-auto bg-white p-6 md:p-10 lg:p-14 scroll-smooth">
                <!-- Se eliminó el mx-auto y max-w para que ocupe todo el ancho -->
                <div id="main-content" class="w-full text-slate-700 leading-relaxed">
                </div>
            </main>
        </div>
    </div>

    <script>
        // CARGA AUTOMÁTICA AL ABRIR LA PÁGINA
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const fileName = './anexo_no._5_manual_comunes_tramientos_urbanisticos_.html';
                const response = await fetch(fileName);
                if (!response.ok) throw new Error('No se pudo cargar el archivo automáticamente.');
                
                const htmlText = await response.text();
                processAndRender(htmlText);
                
            } catch (error) {
                console.warn('Carga automática bloqueada. Mostrando subida manual.', error);
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('upload-screen').classList.remove('hidden');
            }
        });

        // PLAN B: CARGA MANUAL
        document.getElementById('upload-html').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                processAndRender(e.target.result);
            };
            reader.readAsText(file);
        });

        function processAndRender(rawHtml) {
            // 1. EL RESCATE DE LOS NÚMEROS DE WORD
            let cleaned = rawHtml.replace(new RegExp('<!--\\[if [^\\]]+\\]>([\\s\\S]*?)<!\\[endif\\]-->', 'gi'), '$1');
            cleaned = cleaned.replace(new RegExp('<!\\[if [^\\]]+\\]>([\\s\\S]*?)<!\\[endif\\]>', 'gi'), '$1');
            cleaned = cleaned.replace(/<o:p>&nbsp;<\/o:p>/g, ''); 
            cleaned = cleaned.replace(/<o:p>[^<]*<\/o:p>/g, ''); 
            
            // 2. PARSEO A DOM
            const parser = new DOMParser();
            const doc = parser.parseFromString(cleaned, 'text/html');

            // --- PURGADOR DE METADATOS Y FUENTES ---
            // Eliminar el bloque de propiedades del documento (Author, Revision, etc.) que Word oculta en <xml>
            doc.querySelectorAll('xml').forEach(el => el.remove());

            doc.body.querySelectorAll('*').forEach(el => {
                // Elimina el atributo <font face="...">
                if (el.tagName.toLowerCase() === 'font') {
                    el.removeAttribute('face');
                }
                // Elimina estilos en línea que fuercen una tipografía, interlineado o justificación diferente
                if (el.style) {
                    if (el.style.fontFamily) el.style.fontFamily = '';
                    if (el.style.lineHeight) el.style.lineHeight = '';
                    if (el.style.textAlign) el.style.textAlign = '';
                }
            });

            const toc = [];
            let currentChapter = null;
            let currentContextId = 'doc'; // MEJORA: Rastrea el bloque numérico padre para evitar IDs duplicados

            // Extraemos párrafos y cabeceras
            const blocks = Array.from(doc.body.querySelectorAll('p, h1, h2, h3, h4, h5, h6'));

            blocks.forEach(el => {
                if (el.closest('table')) return; // Ignorar tablas

                const text = el.textContent.replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/\s+/g, ' ').trim();
                if (!text) return;

                const cleanTextForRegex = text.replace(/^[•\-\*·¨©oO]\s*/, '').trim();

                // Identificadores Regex ampliados
                const capMatch = cleanTextForRegex.match(/^(?:CAP[ÍI]TULO\s+([0-9IVX]+)|([0-9IVX]+)\.)[\.\-]?\s+(.*)/i);
                const secMatch = cleanTextForRegex.match(/^(?:(?:ART[ÍI]CULO|SECCI[ÓO]N|SUBSECCI[ÓO]N|PAR[AÁ]GRAFO)[^\d]*\d+\.?\s*)?((?:\d+\s*[\.\-\,]\s*)+\d+)[A-Za-z]?[\.\)\-]?\s*(.*)/i);
                const aparMatch = cleanTextForRegex.match(/^([A-Z])[\.\)\-]\s+(.*)/);
                const aparSubMatch = cleanTextForRegex.match(/^([A-Z](?:\.\d+)+)[\.\)\-]?\s+(.*)/);

                if (capMatch) {
                    const num = capMatch[1] || capMatch[2];
                    const titleText = capMatch[3] || '';
                    const id = 'cap-' + num;
                    
                    currentContextId = id; // Actualizamos el contexto padre

                    // Purgamos los estilos base de Word
                    el.removeAttribute('style');
                    el.id = id;
                    el.className = 'visor-chapter-title';
                    
                    // REEMPLAZO VISUAL DE CAPÍTULOS (Caja + Texto)
                    el.innerHTML = `<span class="bg-slate-900 text-white px-3.5 py-1.5 rounded shadow-sm text-sm font-bold tracking-widest uppercase flex-shrink-0 mt-0.5">CAPÍTULO ${num}</span> <span class="flex-1">${titleText}</span>`;

                    currentChapter = { id: id, title: `CAPÍTULO ${num}. ${titleText}`, sections: [] };
                    toc.push(currentChapter);
                } 
                else if (secMatch) {
                    if (!currentChapter) {
                        currentChapter = { id: 'cap-0', title: 'General', sections: [] };
                        toc.push(currentChapter);
                    }
                    const num = secMatch[1].replace(/\s*[\.\-\,]\s*/g, '.');
                    const titleText = secMatch[2] || '';
                    const depth = num.split('.').length;
                    const id = 'sec-' + num.replace(/\./g, '-');
                    
                    currentContextId = id; // Actualizamos el contexto padre

                    // Purgamos los estilos base de Word
                    el.removeAttribute('style');
                    el.id = id;
                    el.className = `visor-section-title visor-depth-${depth}`;
                    
                    // CLASES DINÁMICAS (CAJAS RELLENAS) SEGÚN PROFUNDIDAD
                    let bgClass = depth === 2 ? 'bg-slate-800' : (depth === 3 ? 'bg-slate-600' : (depth === 4 ? 'bg-slate-500' : 'bg-slate-400'));
                    let sizeClass = depth === 2 ? 'text-sm px-2.5 py-1' : (depth === 3 ? 'text-sm px-2.5 py-0.5' : 'text-xs px-2 py-0.5');

                    el.innerHTML = `<span class="${bgClass} text-white rounded shadow-sm flex-shrink-0 ${sizeClass} mt-0.5 font-medium tracking-wide">${num}</span><span class="flex-1">${titleText}</span>`;

                    currentChapter.sections.push({ id: id, title: `${num} ${titleText}`, depth: depth, type: 'sec' });
                }
                else if (aparMatch && currentChapter) {
                    const num = aparMatch[1];
                    const titleText = aparMatch[2] || '';
                    
                    // MEJORA: Generamos un ID 100% único fusionándolo con su padre numérico
                    const id = currentContextId + '-ap-' + num; 
                    
                    el.removeAttribute('style');
                    el.id = id;
                    el.className = `visor-section-title visor-depth-5`;
                    el.innerHTML = `<span class="bg-blue-50 border border-blue-200 text-blue-800 px-2 py-0.5 rounded shadow-sm text-sm flex-shrink-0 mt-0.5 font-bold">${num}.</span><span class="flex-1">${titleText}</span>`;
                    
                    currentChapter.sections.push({ id: id, title: `${num}. ${titleText}`, depth: 5, type: 'apar' });
                }
                else if (aparSubMatch && currentChapter) {
                    const num = aparSubMatch[1].replace(/\s*[\.\-]\s*/g, '.');
                    const titleText = aparSubMatch[2] || '';
                    
                    // MEJORA: Generamos un ID 100% único fusionándolo con su padre numérico
                    const id = currentContextId + '-ap-' + num.replace(/\./g, '-'); 
                    
                    el.removeAttribute('style');
                    el.id = id;
                    el.className = `visor-section-title visor-depth-6`;
                    el.innerHTML = `<span class="bg-blue-50 border border-blue-100 text-blue-700 px-2 py-0.5 rounded shadow-sm text-xs flex-shrink-0 mt-0.5 font-bold">${num}</span><span class="flex-1">${titleText}</span>`;
                    
                    currentChapter.sections.push({ id: id, title: `${num} ${titleText}`, depth: 6, type: 'aparSub' });
                }
            });

            // 4. INYECTAR EL HTML ORIGINAL Y ESTILOS
            const container = document.getElementById('main-content');
            
            // INYECTAR PORTADA SÚPER ELEGANTE
            container.innerHTML = `
                <div id="portada" class="mb-16 pb-16 border-b-2 border-slate-100 flex flex-col items-center justify-center text-center mt-8 md:mt-16">
                    <div class="w-16 h-1 bg-blue-600 mb-8 rounded-full"></div>
                    
                    <div class="bg-slate-50 p-8 md:p-12 rounded-3xl border border-slate-200 shadow-sm max-w-4xl w-full mb-12 flex flex-col items-center text-center">
                        <p class="text-sm md:text-base font-bold text-blue-600 tracking-widest uppercase mb-4">SECRETARÍA DISTRITAL DE PLANEACIÓN</p>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800 mb-6">DECRETO DISTRITAL 555 DE 2021</h2>
                        <p class="text-lg md:text-xl text-slate-500 italic max-w-3xl leading-relaxed px-4">“Por el cual se adopta la revisión general del Plan de Ordenamiento territorial de Bogotá, D.C.”</p>
                    </div>

                    <h1 class="text-xl md:text-2xl lg:text-3xl font-black text-slate-900 leading-tight mb-4 tracking-tight">ACTUALIZACIÓN ANEXO No. 5:</h1>
                    <h3 class="text-base md:text-lg font-bold text-slate-700 leading-snug max-w-4xl">MANUAL DE NORMAS COMUNES A LOS TRATAMIENTOS URBANÍSTICOS</h3>
                </div>
            `;
            
            const styles = doc.head.querySelectorAll('style');
            styles.forEach(style => container.appendChild(style.cloneNode(true)));

            while (doc.body.firstChild) {
                container.appendChild(doc.body.firstChild);
            }

            // 5. CONSTRUIR LA BARRA LATERAL
            buildSidebar(toc);

            // 6. CAMBIO DE PANTALLA
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');

            initScrollSpy();
        }

        function buildSidebar(tocData) {
            const container = document.getElementById('sidebar-content');
            container.innerHTML = '';

            if (tocData.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-500 p-4">No se detectaron capítulos. Revisa el formato del documento.</p>';
                return;
            }

            tocData.forEach((chapter, index) => {
                const details = document.createElement('details');
                if (index === 0) details.open = true;

                const summary = document.createElement('summary');
                summary.className = 'chapter-summary font-bold text-slate-800 py-3 px-3 hover:bg-slate-100 transition-colors rounded-lg text-sm tracking-tight mb-1';
                
                // Aplicamos visited:text-current para evitar que el capítulo se ponga morado
                summary.innerHTML = `<a href="#${chapter.id}" class="nav-link text-current visited:text-current flex-1" onclick="event.stopPropagation();">${chapter.title}</a><span class="icon text-slate-400">▶</span>`;
                
                const list = document.createElement('div');
                list.className = 'section-list pl-1 mt-1 mb-3';

                chapter.sections.forEach(sec => {
                    const link = document.createElement('a');
                    link.href = `#${sec.id}`;
                    
                    let padding, size, border, color, hover;

                    // Clases dinámicas del panel de navegación (Agregamos "visited:..." a cada color)
                    if (sec.type === 'sec') {
                        padding = sec.depth === 2 ? 'pl-4' : (sec.depth === 3 ? 'pl-8' : (sec.depth === 4 ? 'pl-11' : 'pl-14'));
                        size = sec.depth === 2 ? 'text-[13px] font-semibold' : (sec.depth === 3 ? 'text-xs font-medium' : 'text-[11px]');
                        border = sec.depth === 2 ? 'border-l-2 border-transparent hover:border-blue-500' : 'border-l border-slate-200 hover:border-slate-300';
                        color = sec.depth === 2 ? 'text-slate-700 visited:text-slate-700' : 'text-slate-500 visited:text-slate-500';
                        hover = 'hover:text-blue-700 hover:bg-slate-100/50';
                    } else {
                        padding = sec.type === 'apar' ? 'pl-14' : 'pl-16';
                        size = 'text-[11px] font-medium tracking-wide';
                        border = 'border-l border-blue-100';
                        color = 'text-blue-600 visited:text-blue-600';
                        hover = 'hover:text-blue-800 hover:bg-blue-50/50';
                    }

                    link.className = `nav-link block py-2 pr-2 ${padding} ${size} ${color} ${border} ${hover} rounded-r-md transition-colors leading-tight`;
                    link.textContent = sec.title;
                    list.appendChild(link);
                });

                details.appendChild(summary);
                details.appendChild(list);
                container.appendChild(details);
            });
        }

        // CONTROLADORES DE INTERFAZ
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const menuBtn = document.getElementById('menu-btn');
        const closeBtn = document.getElementById('close-menu-btn');

        const toggleMenu = (show) => {
            sidebar.classList.toggle('-translate-x-full', !show);
            overlay.classList.toggle('hidden', !show);
        };

        menuBtn.addEventListener('click', () => toggleMenu(true));
        closeBtn.addEventListener('click', () => toggleMenu(false));
        overlay.addEventListener('click', () => toggleMenu(false));

        // MEJORA: Desplazamiento suave al hacer clic en el menú
        document.getElementById('sidebar').addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (link) {
                if (window.innerWidth < 768) toggleMenu(false);
                
                e.preventDefault(); // Evita el salto brusco nativo
                const targetId = link.getAttribute('href').substring(1);
                const targetEl = document.getElementById(targetId);
                const contentPane = document.getElementById('content-pane');
                
                if (targetEl && contentPane) {
                    // Calcula la posición exacta con un pequeño margen superior (padding)
                    const paneTop = contentPane.getBoundingClientRect().top;
                    const targetTop = targetEl.getBoundingClientRect().top;
                    const offset = targetTop - paneTop + contentPane.scrollTop - 40; 
                    
                    contentPane.scrollTo({
                        top: offset,
                        behavior: 'smooth'
                    });
                }
            }
        });

        document.getElementById('search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.nav-link').forEach(link => {
                const match = link.textContent.toLowerCase().includes(term);
                link.style.display = match || term === '' ? 'block' : 'none';
            });
            if (term !== '') document.querySelectorAll('details').forEach(d => d.open = true);
        });

        // NUEVO MOTOR DE SCROLL SPY (Optimizado sin saltos)
        function initScrollSpy() {
            const contentPane = document.getElementById('content-pane');
            const headings = Array.from(document.querySelectorAll('.visor-chapter-title, .visor-section-title'));
            const navLinks = document.querySelectorAll('.nav-link');
            
            if (headings.length === 0) return;

            let debounceTimer;
            let lastActiveId = null; // Memoria para evitar actualizaciones redundantes
            
            contentPane.addEventListener('scroll', () => {
                if (debounceTimer) clearTimeout(debounceTimer);
                
                debounceTimer = setTimeout(() => {
                    let currentActiveId = headings[0].id;
                    const paneTop = contentPane.getBoundingClientRect().top;

                    // Busca la sección más cercana a la parte superior de la pantalla
                    for (let i = 0; i < headings.length; i++) {
                        const rect = headings[i].getBoundingClientRect();
                        // 150px es el margen de holgura desde arriba
                        if (rect.top - paneTop <= 150) { 
                            currentActiveId = headings[i].id;
                        } else {
                            break;
                        }
                    }

                    // CRÍTICO: Solo anima el menú si realmente cambiaste de sección
                    if (currentActiveId === lastActiveId) return;
                    lastActiveId = currentActiveId;

                    // Actualiza el menú lateral
                    navLinks.forEach(link => {
                        const isActive = link.getAttribute('href') === `#${currentActiveId}`;
                        link.classList.toggle('active', isActive);
                        
                        if (isActive) {
                            // Mantiene abiertos los desplegables padres
                            let parent = link.closest('details');
                            while (parent) {
                                parent.open = true;
                                parent = parent.parentElement.closest('details');
                            }
                            
                            // Auto-Scroll suave y centrado del menú lateral
                            const sidebarContainer = document.getElementById('sidebar');
                            const linkRect = link.getBoundingClientRect();
                            const sidebarRect = sidebarContainer.getBoundingClientRect();
                            
                            if (linkRect.top < sidebarRect.top || linkRect.bottom > sidebarRect.bottom) {
                                link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    });
                }, 50); // Un debounce de 50ms hace la lectura fluida sin forzar el procesador
            });
            
            // Disparar el cálculo la primera vez que carga
            contentPane.dispatchEvent(new Event('scroll'));
        }
    </script>
</body>
</html>